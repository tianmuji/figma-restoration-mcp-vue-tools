# Phase 1分析：正确节点ID识别流程

## 问题背景
在Phase 1分析阶段，当用户提供Figma链接时，必须正确识别和选择节点ID。用户提供的链接中的node-id可能是容器节点，需要进一步分析Figma JSON找到真正的素材节点。

## 核心原则
**用户提供的节点ID ≠ 最终下载的节点ID**
- 用户链接中的node-id通常是语义化的容器节点
- 真正的素材节点在容器的子元素中
- 必须通过Figma JSON分析找到正确的素材节点

## 标准流程

### 1. 用户提供链接时的处理
当用户提供类似 `https://www.figma.com/design/...?node-id=9310-98365&m=dev` 的链接时：

#### 1.1 提取节点ID
- 从URL中提取 `9310-98365`
- 转换为Figma格式 `9310:98365` (使用冒号分隔符)

#### 1.2 分析节点信息
在Figma JSON中查找该节点：
```json
{
  "id": "9310:98365",
  "name": "新/cs_ic_ai_question_search_ai搜题",
  "type": "INSTANCE",
  "componentId": "9350:79190"
}
```

#### 1.3 判断节点类型
- **语义化名称** → 容器节点
  - 示例: `"新/cs_ic_ai_question_search_ai搜题"`、`"单选"`、`"按钮"`
  - 特征: 功能性描述、中文语义、组件类型名
- **具体形状名称** → 素材节点
  - 示例: `"Rectangle 3467668"`、`"Vector 297"`、`"Path 123"`
  - 特征: 技术性描述、形状类型+数字编号

### 2. 节点ID查找策略

#### 2.1 容器节点处理
如果用户提供的节点是容器节点：
1. **查找子元素**: 在 `children` 数组中查找具体素材
2. **分析子节点**: 检查每个子节点的 `name` 和 `type`
3. **选择素材节点**: 优先选择 `RECTANGLE/VECTOR/PATH` 类型的节点

#### 2.2 查找示例
```javascript
// 用户提供: node-id=9310-98365
// 在Figma JSON中查找:
{
  "id": "9310:98365",
  "name": "新/cs_ic_ai_question_search_ai搜题",  // 容器节点
  "type": "INSTANCE",
  "children": [
    {
      "id": "I9310:98365;12982:842",  // 具体素材节点
      "name": "Rectangle 3467668",
      "type": "IMAGE-SVG"
    },
    {
      "id": "I9310:98365;12982:841",
      "name": "Rectangle 3467667", 
      "type": "IMAGE-SVG"
    }
  ]
}
```

### 3. 正确的下载策略

#### 3.1 节点选择原则
- **容器节点** (`9310:98365`): 包含多个子元素，通常不是纯净素材
- **具体素材节点** (`I9310:98365;12982:842`): 单个绘制元素，是真正的素材
- **选择原则**: 优先下载具体素材节点，确保CSS尺寸与SVG内容精确匹配

#### 3.2 特殊情况处理
- **多个子元素**: 选择最主要的视觉元素，通常是最大的或最复杂的
- **嵌套层级**: 可能需要深入多层才能找到真正的素材节点
- **组件实例**: 检查 `componentId` 对应的组件定义

### 4. 实际操作示例

#### 4.1 AI搜题图标
```javascript
// 用户提供链接: node-id=9310-98365
// 分析结果:
{
  "id": "9310:98365",
  "name": "新/cs_ic_ai_question_search_ai搜题",  // 容器
  "children": [
    {
      "id": "I9310:98365;12982:842",  // 选择这个
      "name": "Rectangle 3467668",
      "type": "IMAGE-SVG"
    }
  ]
}
// 最终下载: I9310:98365;12982:842
```

#### 4.2 AI图标
```javascript
// 在JSON中查找 "cs_ic_ai_ai1"
// 找到:
{
  "id": "I9310:98165;12840:90365",
  "name": "新/cs_ic_ai_ai1",
  "type": "INSTANCE"
}
// 最终下载: I9310:98165;12840:90365
```

### 5. 验证方法

#### 5.1 节点名称验证
- 容器节点: 语义化名称，如功能描述
- 素材节点: 技术性名称，如形状类型+编号

#### 5.2 节点类型验证
- 优先选择: `RECTANGLE`、`VECTOR`、`PATH`、`IMAGE-SVG`
- 避免选择: `INSTANCE`、`COMPONENT`、`GROUP`、`FRAME`

#### 5.3 尺寸验证
- 检查 `boundingBox` 尺寸是否合理
- 确保尺寸与CSS使用尺寸匹配

## 关键经验

### 1. 必须分析Figma JSON
**不能直接使用用户提供的节点ID**
- 用户提供的通常是容器节点
- 需要通过JSON分析找到真正的素材节点
- 这是确保素材质量的关键步骤

### 2. 节点名称是重要线索
**通过名称可以快速判断节点类型**
- 语义化名称 → 容器节点
- 技术性名称 → 素材节点
- 这是最可靠的判断方法

### 3. 层级选择策略
**优先选择最具体的视觉实现层级**
- 跳过语义化的容器层
- 直接获取绘制形状层
- 避免不必要的嵌套结构

## 注意事项

### 1. 节点ID格式
- Figma使用冒号分隔符: `9310:98365`
- URL中使用连字符: `9310-98365`
- 转换时注意格式差异

### 2. 复杂组件处理
- 某些复杂组件可能需要保持容器结构
- 需要结合视觉分析判断
- 必要时可以下载多个相关节点

### 3. 错误处理
- 如果找不到合适的子节点，回退到容器节点
- 记录分析过程，便于调试
- 在metadata中记录最终选择的节点ID

## 适用场景
- 所有需要下载素材的Figma组件还原
- 用户提供具体节点链接的情况
- 需要精确匹配CSS尺寸的素材

## 不适用场景
- 整体页面截图下载
- 复杂插画的多层级结构
- 需要保持完整组件结构的场景
